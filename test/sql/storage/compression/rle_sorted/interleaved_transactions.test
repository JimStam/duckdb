# name: test/sql/storage/compression/rle_sorted/interleaved_transactions.test
# description: Small version of test/sql/storage/test_large_interleaved_updates_deletes.test_slow (use STANDARD_VECTOR_SIZE=2)
# group: [rle_sorted]

# load the DB from disk
load __TEST_DIR__/test_large_interleaved.db

#mode output_result

statement ok
CREATE TABLE test (a INTEGER, b INTEGER);

# deletes
statement ok con1
BEGIN TRANSACTION

statement ok con2
BEGIN TRANSACTION

# both con1 and con2 insert a large amount of tuples
statement ok con1
INSERT INTO test SELECT a, b FROM (VALUES (1, 2)) tbl1(a,b), repeat(0, 480) tbl2(c)

statement ok con2
INSERT INTO test SELECT a, b FROM (VALUES (3, 4)) tbl1(a,b), repeat(0, 480) tbl2(c)

# both con1 and con2 do some deletes
statement error con1
DELETE FROM test WHERE a=1

statement error con2
DELETE FROM test WHERE a=3

statement ok con1
ROLLBACK

statement ok con2
ROLLBACK

# updates
statement ok con1
BEGIN TRANSACTION

statement ok con2
BEGIN TRANSACTION

# both con1 and con2 insert a large amount of tuples
statement ok con1
INSERT INTO test SELECT a, b FROM (VALUES (6, 7)) tbl1(a,b), repeat(0, 480) tbl2(c)

statement ok con2
INSERT INTO test SELECT a, b FROM (VALUES (9, 10)) tbl1(a,b), repeat(0, 480) tbl2(c)

# both con1 and con2 do some updates
statement ok con1
UPDATE test SET b=8 WHERE a=6

statement ok con2
UPDATE test SET b=11 WHERE a=9

query III con1
SELECT a, b, COUNT(*) FROM test GROUP BY a, b ORDER BY a, b
----
6	8	480

query III con2
SELECT a, b, COUNT(*) FROM test GROUP BY a, b ORDER BY a, b
----
9	11	480

statement ok con1
COMMIT

statement ok con2
COMMIT

query III
SELECT a, b, COUNT(*) FROM test GROUP BY a, b ORDER BY a, b
----
6	8	480
9	11	480

restart

query III
SELECT a, b, COUNT(*) FROM test GROUP BY a, b ORDER BY a, b
----
6	8	480
9	11	480
