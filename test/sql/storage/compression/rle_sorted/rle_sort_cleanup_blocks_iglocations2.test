# name: test/sql/storage/compression/rle_sorted/rle_sort_cleanup_blocks_iglocations2.test
# description: Test the cleaning up of reshuffled blocks
# group: [rle_sorted]

# load the DB from disk
load /test_nosort.db

#statement ok
#PRAGMA wal_autocheckpoint='1TB';
#
#statement ok
#PRAGMA force_compression_sorting=false
#
#statement ok
#CREATE TABLE "IGlocations2_2"(
#  "Number of Records" smallint,
#  "caption" varchar(3688) NOT NULL,
#  "city" varchar(35) NOT NULL,
#  "country" varchar(2) NOT NULL,
#  "created_time" timestamp NOT NULL,
#  "id" integer NOT NULL,
#  "latitude" decimal(10, 8) NOT NULL,
#  "like_count" integer NOT NULL,
#  "link" varchar(35) NOT NULL,
#  "longitude" decimal(11, 8) NOT NULL,
#  "media_type" varchar(5) NOT NULL,
#  "media_url" varchar(153) NOT NULL,
#  "State (copy)" varchar(16) NOT NULL,
#  "state" varchar(16) NOT NULL,
#  "username" varchar(30) NOT NULL,
#  "Calculation_1750724145742463" decimal(5, 2) NOT NULL,
#  "Calculation_3650724144057954" varchar(8) NOT NULL,
#  "Calculation_4370724142342227" varchar(5),
#  "Calculation_8090724143600502" varchar(5) NOT NULL,
#  "Calculation_9330724145728972" decimal(4, 2) NOT NULL
#);
#
#statement ok
#CREATE TABLE "IGlocations2_1"(
#  "Number of Records" smallint,
#  "caption" varchar(3688) NOT NULL,
#  "city" varchar(35) NOT NULL,
#  "country" varchar(2) NOT NULL,
#  "created_time" timestamp NOT NULL,
#  "id" integer NOT NULL,
#  "latitude" decimal(10, 8) NOT NULL,
#  "like_count" integer NOT NULL,
#  "link" varchar(35) NOT NULL,
#  "longitude" decimal(11, 8) NOT NULL,
#  "media_type" varchar(5) NOT NULL,
#  "media_url" varchar(153) NOT NULL,
#  "State (copy)" varchar(16) NOT NULL,
#  "state" varchar(16) NOT NULL,
#  "username" varchar(30) NOT NULL,
#  "Calculation_1750724145742463" decimal(5, 2) NOT NULL,
#  "Calculation_3650724144057954" varchar(8) NOT NULL,
#  "Calculation_4370724142342227" varchar(5),
#  "Calculation_8090724143600502" varchar(5) NOT NULL,
#  "Calculation_9330724145728972" decimal(4, 2) NOT NULL
#);
#
#statement ok
#COPY IGlocations2_1 FROM '/IGlocations2_1.csv.gz' ( DELIMITER '|', NULL 'null', QUOTE '', ESCAPE '\\n' );
#
#statement ok
#COPY IGlocations2_2 FROM '/IGlocations2_2.csv.gz' ( DELIMITER '|', NULL 'null', QUOTE '', ESCAPE '\\n' );
#
#statement ok
#CHECKPOINT;
#
#mode output_result
#
## Check the size of the RLE compressed blocks
#statement ok
#select count(distinct block_id) from pragma_storage_info('IGlocations2_1') where segment_type not in('VARCHAR', 'VALIDITY')
#
#statement ok
#select count(distinct block_id) from pragma_storage_info('IGlocations2_2') where segment_type not in('VARCHAR', 'VALIDITY')
#
## Check the size of the remaining blocks
#statement ok
#select count(distinct block_id) from pragma_storage_info('IGlocations2_1')
#
#statement ok
#select count(distinct block_id) from pragma_storage_info('IGlocations2_2')

## Check with sorting
#
#statement ok
#DROP TABLE IGlocations2_1;
#
#statement ok
#DROP TABLE IGlocations2_2;
#
#restart
#
statement ok
PRAGMA wal_autocheckpoint='1TB';

statement ok
PRAGMA force_compression_sorting=true

statement ok
CREATE TABLE "IGlocations2_2"(
  "Number of Records" smallint,
  "caption" varchar(3688) NOT NULL,
  "city" varchar(35) NOT NULL,
  "country" varchar(2) NOT NULL,
  "created_time" timestamp NOT NULL,
  "id" integer NOT NULL,
  "latitude" decimal(10, 8) NOT NULL,
  "like_count" integer NOT NULL,
  "link" varchar(35) NOT NULL,
  "longitude" decimal(11, 8) NOT NULL,
  "media_type" varchar(5) NOT NULL,
  "media_url" varchar(153) NOT NULL,
  "State (copy)" varchar(16) NOT NULL,
  "state" varchar(16) NOT NULL,
  "username" varchar(30) NOT NULL,
  "Calculation_1750724145742463" decimal(5, 2) NOT NULL,
  "Calculation_3650724144057954" varchar(8) NOT NULL,
  "Calculation_4370724142342227" varchar(5),
  "Calculation_8090724143600502" varchar(5) NOT NULL,
  "Calculation_9330724145728972" decimal(4, 2) NOT NULL
);

statement ok
CREATE TABLE "IGlocations2_1"(
  "Number of Records" smallint,
  "caption" varchar(3688) NOT NULL,
  "city" varchar(35) NOT NULL,
  "country" varchar(2) NOT NULL,
  "created_time" timestamp NOT NULL,
  "id" integer NOT NULL,
  "latitude" decimal(10, 8) NOT NULL,
  "like_count" integer NOT NULL,
  "link" varchar(35) NOT NULL,
  "longitude" decimal(11, 8) NOT NULL,
  "media_type" varchar(5) NOT NULL,
  "media_url" varchar(153) NOT NULL,
  "State (copy)" varchar(16) NOT NULL,
  "state" varchar(16) NOT NULL,
  "username" varchar(30) NOT NULL,
  "Calculation_1750724145742463" decimal(5, 2) NOT NULL,
  "Calculation_3650724144057954" varchar(8) NOT NULL,
  "Calculation_4370724142342227" varchar(5),
  "Calculation_8090724143600502" varchar(5) NOT NULL,
  "Calculation_9330724145728972" decimal(4, 2) NOT NULL
);

statement ok
COPY IGlocations2_1 FROM '/IGlocations2_1.csv.gz' ( DELIMITER '|', NULL 'null', QUOTE '', ESCAPE '\\n' );

statement ok
COPY IGlocations2_2 FROM '/IGlocations2_2.csv.gz' ( DELIMITER '|', NULL 'null', QUOTE '', ESCAPE '\\n' );

statement ok
CHECKPOINT;

mode output_result

# Check the size of the RLE compressed blocks
statement ok
select count(distinct block_id) from pragma_storage_info('IGlocations2_1') where segment_type not in('VARCHAR', 'VALIDITY')

statement ok
select count(distinct block_id) from pragma_storage_info('IGlocations2_2') where segment_type not in('VARCHAR', 'VALIDITY')

# Check the size of the remaining blocks
statement ok
select count(distinct block_id) from pragma_storage_info('IGlocations2_1')

statement ok
select count(distinct block_id) from pragma_storage_info('IGlocations2_2')