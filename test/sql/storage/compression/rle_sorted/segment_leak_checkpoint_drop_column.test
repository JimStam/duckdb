# name: test/sql/storage/compression/rle_sorted/segment_leak_checkpoint_drop_column.test
# description: Test that we do not add a segment per checkpoint when dropping a column
# group: [rle_sorted]

#mode output_result

load __TEST_DIR__/test_segment_leak.db

statement ok
PRAGMA force_checkpoint;

statement ok
PRAGMA preserve_insertion_order = false;

statement ok
PRAGMA force_row_group_replacement = true;

statement ok
CREATE TABLE integers AS SELECT i, i j FROM range(1024) tbl(i);

query III
SELECT MIN(j), MAX(j), COUNT(*) FROM integers
----
0	1023	1024


statement ok
ALTER TABLE integers DROP COLUMN j;

statement ok
ALTER TABLE integers ADD COLUMN j INTEGER;

statement ok
UPDATE integers SET j=i;

query III
SELECT MIN(j), MAX(j), COUNT(*) FROM integers
----
0	1023	1024

query I nosort expected_blocks
select total_blocks from pragma_database_size();

query III
SELECT MIN(i), MAX(i), COUNT(*) FROM integers
----
0	1023	1024
